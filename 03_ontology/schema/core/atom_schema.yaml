# GR Universal Atom Schema
# Version: 2.0
# Last Updated: 2026-02-03
#
# 헌법: ../constitution/GR_KNOWLEDGE_ATOMIZATION_CONSTITUTION.md
# 관계 타입: ./relation_types.yaml
# 원자 태그: ../../taxonomy/atom_tags.yaml

schema:
  version: "2.0"
  description: "GR DB에 저장되는 모든 원자의 구조 정의"

atom:
  # ═══════════════════════════════════════════════════════════════
  # 식별 (Identity) - 필수
  # ═══════════════════════════════════════════════════════════════
  identity:
    id:
      type: string
      pattern: "GR-{DOMAIN}-{TYPE}-{SEQUENCE}"
      example: "GR-SEC-VUL-00001"
      required: true
      immutable: true

    name:
      type: string
      description: "인간이 읽을 수 있는 이름"
      required: true

    normalization:
      normalized_name:
        type: string
        description: "중복 검사용 정규화된 이름"
        required: true
        computed: true
        validation_rule: |
          - ingest(입력) 시점: 없어도 됨 (시스템이 생성)
          - persist(저장) 직전: 반드시 존재해야 함 (write-time computed)
        rules:
          - "소문자 변환"
          - "특수문자 제거 (알파벳, 숫자, 공백만)"
          - "연속 공백을 단일 공백으로"
          - "앞뒤 공백 제거"
        example:
          input: "SQL Injection (SQLi)"
          output: "sql injection sqli"
      normalization_version:
        type: string
        description: "적용된 정규화 규칙 버전"
        required: true
        default: "1.0"

    aliases:
      type: array
      items: string
      description: "다른 이름, 약어, 번역"
      required: false

  # ═══════════════════════════════════════════════════════════════
  # 분류 (Classification) - 필수
  # ═══════════════════════════════════════════════════════════════
  classification:
    domain:
      type: enum
      values:
        - security
        - network
        - system
        - application
        - data
        - cloud
        - iot
        - ai
      required: true

    type:
      type: enum
      values:
        # 인프라 요소 (entity_class: true)
        - component           # 인프라 구성요소 (Server, Database, Cloud VM)
        - component_tool      # 배포된 도구 (SIEM, EDR, 방어 도구)
        - component_control   # 배포된 보안 통제 (WAF 장비, IDS/IPS)
        
        # 지식 요소 (entity_class: false)
        - concept             # 개념, 사상, 전술 (Zero Trust, Defense in Depth)
        - technique           # 공격/방어 기법 (SQL Injection, Phishing)
        - vulnerability       # 취약점 (CVE, CWE)
        - principle           # 원칙 (Least Privilege, Separation of Duties)
        - pattern             # 패턴, 시그니처 (Payload, Fingerprint)
        - protocol            # 프로토콜, 표준 (HTTP, TLS, OAuth)
        - tool_knowledge      # 도구 지식 (Metasploit 사용법, Burp Suite 기능)
        - control_policy      # 정책/절차 (접근통제 정책, 보안 절차)
      required: true
      note: |
        [GR Framework 분류 원칙]
        - type에 따라 entity_class가 자동 결정됨
        - 인프라 요소: component, component_tool, component_control
        - 지식 요소: 그 외 모든 type

    entity_class:
      type: boolean
      required: true
      description: |
        원자가 실체화될 수 있는 인프라 요소인지 여부
        
        판정 기준 (4가지 질문 중 하나라도 Yes면 true):
        1. 네트워크 주소를 가질 수 있는가?
        2. 프로세스로 실행될 수 있는가?
        3. 물리적 형태가 있을 수 있는가?
        4. 시스템 자원을 소비하는가?
        
        자동 판정:
        - true: component, component_tool, component_control
        - false: concept, technique, vulnerability, principle, 
                 pattern, protocol, tool_knowledge, control_policy

    abstraction_level:
      type: integer
      range: [1, 4]
      description: "1=인스턴스, 2=기법, 3=개념, 4=원리"
      required: true

    # ─────────────────────────────────────────────────────────────
    # 3D 좌표 (entity_class: true인 경우만 사용)
    # ─────────────────────────────────────────────────────────────
    gr_coordinates:
      description: |
        GR Framework 3D 좌표계 (Layer × Zone × Function)
        entity_class: true인 원자만 사용
        
        - Layer: 인프라 추상화 레벨 (L0=External ~ L7=Application, Cross)
        - Zone: 보안 영역 (Z0A, Z0B, Z1~Z5)
        - Function: 기능적 역할 태그 (A1.1, S2.1, M3.2 등 계층적)
      required_if: "entity_class == true"
      
      layer:
        type: string
        pattern: "L[0-7]|Cross"
        description: "GR Framework Layer (L0~L7 또는 Cross)"
        examples: ["L7", "L5", "L2", "Cross"]
        
      zone:
        type: string
        pattern: "Z(0A|0B|[1-5])"
        description: "GR Framework Zone"
        examples: ["Z0A", "Z0B", "Z1", "Z2", "Z3", "Z4", "Z5"]
        
      function:
        type: array
        items: string
        pattern: "[A-Z][0-9]+(\\.[0-9]+)*"
        description: |
          GR Framework Function 태그 (계층적)
          - 02_framework/GR_DB/03_차원3_Function_Tag/ 참조
          - 예: ["A2.2", "S3.1", "M8.2"]
          - 복합 기능 가능 (다중 태그)
        examples:
          - ["A2.2"]                    # Microservices
          - ["A2.2", "S2.1", "M2.1"]   # Microservices + Auth + Logging
          - ["N2.1", "S1.2"]           # Firewall + Encryption

    # ─────────────────────────────────────────────────────────────
    # 적용 범위 (entity_class: false인 경우만 사용)
    # ─────────────────────────────────────────────────────────────
    scope:
      description: |
        지식 원자의 적용 대상/범위
        entity_class: false인 원자만 사용
        
        "이 기법/취약점/개념이 어디에 적용되는가"
      required_if: "entity_class == false"
      
      target_layers:
        type: array
        items: string
        pattern: "L[0-7]|Cross"
        description: "적용 대상 Layer들"
        examples: [["L7"], ["L5", "L7"], ["L2", "L3"]]
        
      target_zones:
        type: array
        items: string
        pattern: "Z(0A|0B|[1-5])"
        description: "적용 대상 Zone들"
        examples: [["Z2"], ["Z2", "Z3"], ["Z1", "Z2"]]
        
      target_functions:
        type: array
        items: string
        description: "적용 대상 Function들 (선택)"
        required: false
        examples: [["A2", "D1"], ["S1", "S2"]]

    # ─────────────────────────────────────────────────────────────
    # 원자 태그 (모든 원자 공통)
    # ─────────────────────────────────────────────────────────────
    atom_tags:
      type: array
      items: string
      description: |
        원자 특성 분류 태그 (taxonomy/atom_tags.yaml 참조)
        - 모든 원자에 적용 가능
        - 검색/필터링/분류 용도
        - Function과 다름 (Function은 인프라 좌표, atom_tags는 특성 분류)
      required: true
      min_items: 1
      examples:
        - ["INJ", "EXPLOIT", "WEB"]      # SQL Injection
        - ["LINUX", "WEB", "PROXY"]      # Nginx
        - ["CRYPTO", "AUTH", "PROTOCOL"] # TLS

  # ═══════════════════════════════════════════════════════════════
  # 정의 (Definition) - 필수
  # ═══════════════════════════════════════════════════════════════
  definition:
    what:
      type: string
      description: "이것은 무엇인가 (본질적 정의)"
      required: true
      max_length: 500

    why:
      type: string
      description: "왜 중요한가 / 왜 존재하는가"
      required: false

    how:
      type: string
      description: "어떻게 작동하는가"
      required: false

  # ═══════════════════════════════════════════════════════════════
  # 관계 (Relations) - 필수 (빈 객체 허용)
  # Canonical 관계만 포함. Inverse는 relation_types.yaml 참조.
  # ※ related_to는 사용 금지 - 정밀한 관계 타입 사용 필수
  # ═══════════════════════════════════════════════════════════════
  relations:
    structural:
      is_a: ["atom_id"]
      part_of: ["atom_id"]
      instance_of: ["atom_id"]
      abstracts: ["atom_id"]

    causal:
      causes: ["atom_id"]
      enables: ["atom_id"]
      prevents: ["atom_id"]

    conditional:
      requires: ["atom_id"]
      conflicts_with: ["atom_id"]
      alternative_to: ["atom_id"]

    temporal:
      precedes: ["atom_id"]
      supersedes: ["atom_id"]

    applicability:
      applies_to: ["atom_id"]
      effective_against: ["atom_id"]

    epistemic:
      contradicts: ["atom_id"]
      disputes: ["atom_id"]
      refines: ["atom_id"]
      
    implementation:
      implements: ["atom_id"]
      description: "프로토콜/표준을 구현함 (component → protocol)"

  # ═══════════════════════════════════════════════════════════════
  # 속성 (Properties) - 도메인별 확장
  # ═══════════════════════════════════════════════════════════════
  properties:
    type: object
    additionalProperties: true
    description: "도메인별 확장 속성 (extensions/ 참조)"

  # ═══════════════════════════════════════════════════════════════
  # 환경적 제약 (Constraints) - 선택
  # ═══════════════════════════════════════════════════════════════
  constraints:
    type: array
    required: false
    description: "조건부 속성 정의"
    items:
      property: string
      base_value: any
      conditions:
        - when:
            context_type: enum[version, platform, configuration, environment]
            condition: string
          then:
            value: any
            reason: string

  # ═══════════════════════════════════════════════════════════════
  # 메타데이터 (Metadata) - 필수
  # ═══════════════════════════════════════════════════════════════
  metadata:
    trust:
      source:
        type: enum
        values: [official, research, community, experimental, ai_generated]
        required: true
      references:
        type: array
        required: false
      confidence:
        type: float
        range: [0.0, 1.0]
        required: true
      decay:
        enabled:
          type: boolean
          default: false
        half_life_days:
          type: "integer | null"
          nullable: true
          description: "신뢰도가 50%로 감소하는 기간 (일), null = 감쇠 없음"
        floor:
          type: float
          range: [0.0, 1.0]
          default: 0.3
        last_validated:
          type: date
      verified:
        status: enum[verified, unverified, deprecated]
        date: date
        by: string

    temporal:
      created:
        type: date
        required: true
      modified:
        type: date
        required: true
      revision:
        type: integer
        required: true
        default: 1
        description: "수정 시마다 +1, lineage.transformations에 기록 필수"
      valid_from:
        type: date
      valid_until:
        type: date
      deprecated:
        type: boolean
        default: false

    lineage:
      ingested_from:
        source_type: enum[document, api, web, manual, ai_generated]
        source_uri: string
        ingestion_date: date
        ingestion_method: string
      transformations:
        type: array
        items:
          operation: enum[extract, normalize, enrich, merge, split, translate, correct, update]
          date: date
          by: string
          details: string
          revision_from: integer
          revision_to: integer
      derived_from:
        type: array
        items: atom_id
      contributed_to:
        type: array
        items: atom_id

    security:
      sensitivity:
        type: enum
        values: [public, internal, confidential, restricted]
        required: true
        default: public
      sharing_policy:
        exportable: boolean
        requires_attribution: boolean
        license: string
      contains_pii:
        type: boolean
        default: false
      weaponization_risk:
        type: enum
        values: [none, low, medium, high]

    ai:
      embedding_text:
        type: string
        required: true
        description: "벡터 임베딩 생성용 텍스트 (50-200단어)"
      search_keywords:
        type: array
        required: true
        min_items: 5
      related_queries:
        type: array
        description: "이 원자가 답이 될 수 있는 질문들"

# ═══════════════════════════════════════════════════════════════
# 변경 이력
# ═══════════════════════════════════════════════════════════════
changelog:
  - version: "2.0"
    date: "2026-02-03"
    changes:
      - "entity_class 필드 추가 (인프라 vs 지식 구분)"
      - "type 값 분리: tool → component_tool, tool_knowledge"
      - "type 값 분리: control → component_control, control_policy"
      - "gr_coordinates.tags → gr_coordinates.function (명칭 변경)"
      - "scope 필드 추가 (entity_class: false용)"
      - "atom_tags 필드 추가 (모든 원자 공통)"
      - "Zone 패턴 수정: Zone[1-7] → Z(0A|0B|[1-5])"
      - "Layer 패턴 수정: L[1-7] → L[0-7]|Cross"
      - "implements 관계 추가 (component → protocol)"
      - "related_to 사용 금지 명시"
      
  - version: "1.2"
    date: "2025-01-26"
    changes:
      - "Initial structured version"
