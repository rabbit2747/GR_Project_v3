# GR Universal Atom Schema
# Version: 1.2
# Last Updated: 2025-01-26
#
# 헌법: ../constitution/GR_KNOWLEDGE_ATOMIZATION_CONSTITUTION.md
# 관계 타입: ./relation_types.yaml

schema:
  version: "1.2"
  description: "GR DB에 저장되는 모든 원자의 구조 정의"

atom:
  # ═══════════════════════════════════════════════════════════════
  # 식별 (Identity) - 필수
  # ═══════════════════════════════════════════════════════════════
  identity:
    id:
      type: string
      pattern: "GR-{DOMAIN}-{TYPE}-{SEQUENCE}"
      example: "GR-SEC-VUL-00001"
      required: true
      immutable: true

    name:
      type: string
      description: "인간이 읽을 수 있는 이름"
      required: true

    normalization:
      normalized_name:
        type: string
        description: "중복 검사용 정규화된 이름"
        required: true
        computed: true
        validation_rule: |
          - ingest(입력) 시점: 없어도 됨 (시스템이 생성)
          - persist(저장) 직전: 반드시 존재해야 함 (write-time computed)
        rules:
          - "소문자 변환"
          - "특수문자 제거 (알파벳, 숫자, 공백만)"
          - "연속 공백을 단일 공백으로"
          - "앞뒤 공백 제거"
        example:
          input: "SQL Injection (SQLi)"
          output: "sql injection sqli"
      normalization_version:
        type: string
        description: "적용된 정규화 규칙 버전"
        required: true
        default: "1.0"

    aliases:
      type: array
      items: string
      description: "다른 이름, 약어, 번역"
      required: false

  # ═══════════════════════════════════════════════════════════════
  # 분류 (Classification) - 필수
  # ═══════════════════════════════════════════════════════════════
  classification:
    domain:
      type: enum
      values:
        - security
        - network
        - system
        - application
        - data
        - cloud
        - iot
        - ai
      required: true

    type:
      type: enum
      values:
        - concept
        - technique
        - tool
        - vulnerability
        - control
        - protocol
        - component
        - pattern
        - principle
      required: true
      note: "type과 abstraction_level은 독립적인 두 축"

    abstraction_level:
      type: integer
      range: [1, 4]
      description: "1=인스턴스, 2=기법, 3=개념, 4=원리"
      required: true
      note: "type과 abstraction_level은 독립적인 두 축"

    gr_coordinates:
      layer:
        type: string
        pattern: "L[1-7]"
        description: "GR Framework Layer"
      zone:
        type: string
        pattern: "Zone[1-7]"
        description: "GR Framework Zone"
      tags:
        type: array
        items: string
        description: "GR Framework Tags"

  # ═══════════════════════════════════════════════════════════════
  # 정의 (Definition) - 필수
  # ═══════════════════════════════════════════════════════════════
  definition:
    what:
      type: string
      description: "이것은 무엇인가 (본질적 정의)"
      required: true
      max_length: 500

    why:
      type: string
      description: "왜 중요한가 / 왜 존재하는가"
      required: false

    how:
      type: string
      description: "어떻게 작동하는가"
      required: false

  # ═══════════════════════════════════════════════════════════════
  # 관계 (Relations) - 필수 (빈 객체 허용)
  # Canonical 관계만 포함. Inverse는 relation_types.yaml 참조.
  # ═══════════════════════════════════════════════════════════════
  relations:
    structural:
      is_a: ["atom_id"]
      part_of: ["atom_id"]
      instance_of: ["atom_id"]
      abstracts: ["atom_id"]

    causal:
      causes: ["atom_id"]
      enables: ["atom_id"]
      prevents: ["atom_id"]

    conditional:
      requires: ["atom_id"]
      conflicts_with: ["atom_id"]
      alternative_to: ["atom_id"]

    temporal:
      precedes: ["atom_id"]
      supersedes: ["atom_id"]

    applicability:
      applies_to: ["atom_id"]
      effective_against: ["atom_id"]

    epistemic:
      contradicts: ["atom_id"]
      disputes: ["atom_id"]
      refines: ["atom_id"]

  # ═══════════════════════════════════════════════════════════════
  # 속성 (Properties) - 도메인별 확장
  # ═══════════════════════════════════════════════════════════════
  properties:
    type: object
    additionalProperties: true
    description: "도메인별 확장 속성 (extensions/ 참조)"

  # ═══════════════════════════════════════════════════════════════
  # 환경적 제약 (Constraints) - 선택
  # ═══════════════════════════════════════════════════════════════
  constraints:
    type: array
    required: false
    description: "조건부 속성 정의"
    items:
      property: string
      base_value: any
      conditions:
        - when:
            context_type: enum[version, platform, configuration, environment]
            condition: string
          then:
            value: any
            reason: string

  # ═══════════════════════════════════════════════════════════════
  # 메타데이터 (Metadata) - 필수
  # ═══════════════════════════════════════════════════════════════
  metadata:
    trust:
      source:
        type: enum
        values: [official, research, community, experimental]
        required: true
      references:
        type: array
        required: false
      confidence:
        type: float
        range: [0.0, 1.0]
        required: true
      decay:
        enabled:
          type: boolean
          default: false
        half_life_days:
          type: "integer | null"
          nullable: true
          description: "신뢰도가 50%로 감소하는 기간 (일), null = 감쇠 없음"
        floor:
          type: float
          range: [0.0, 1.0]
          default: 0.3
        last_validated:
          type: date
      verified:
        status: enum[verified, unverified, deprecated]
        date: date
        by: string

    temporal:
      created:
        type: date
        required: true
      modified:
        type: date
        required: true
      revision:
        type: integer
        required: true
        default: 1
        description: "수정 시마다 +1, lineage.transformations에 기록 필수"
      valid_from:
        type: date
      valid_until:
        type: date
      deprecated:
        type: boolean
        default: false

    lineage:
      ingested_from:
        source_type: enum[document, api, web, manual, ai_generated]
        source_uri: string
        ingestion_date: date
        ingestion_method: string
      transformations:
        type: array
        items:
          operation: enum[extract, normalize, enrich, merge, split, translate, correct, update]
          date: date
          by: string
          details: string
          revision_from: integer
          revision_to: integer
      derived_from:
        type: array
        items: atom_id
      contributed_to:
        type: array
        items: atom_id

    security:
      sensitivity:
        type: enum
        values: [public, internal, confidential, restricted]
        required: true
        default: public
      sharing_policy:
        exportable: boolean
        requires_attribution: boolean
        license: string
      contains_pii:
        type: boolean
        default: false
      weaponization_risk:
        type: enum
        values: [none, low, medium, high]

    ai:
      embedding_text:
        type: string
        required: true
        description: "벡터 임베딩 생성용 텍스트 (50-200단어)"
      search_keywords:
        type: array
        required: true
        min_items: 5
      related_queries:
        type: array
        description: "이 원자가 답이 될 수 있는 질문들"
